(function(){function e(e){var n=e.getAttribute("data-src"),o=n+"&type="+r.defaultVoice;!0===r.autoAudio&&t(o),e.addEventListener("click",function(e){t(o)})}function t(e){chrome.runtime.sendMessage({type:"voice",src:e})}function n(e,t){return e.top===t.top&&e.bottom===t.bottom&&e.left===t.left&&e.right===t.right}var o,i={top:0,bottom:0,left:0,right:0,again:0},r={};chrome.storage.sync.get(null,function(e){for(var t in e)r[t]=e[t]}),chrome.storage.onChanged.addListener(function(e){void 0!==e.linkQuery&&(r.linkQuery=e.linkQuery.newValue),void 0!==e.useHttps&&(r.useHttps=e.useHttps.newValue),void 0!==e.autoAudio&&(r.autoAudio=e.autoAudio.newValue),void 0!==e.defaultVoice&&(r.defaultVoice=e.defaultVoice.newValue),void 0!==e.selectMode&&(r.selectMode=e.selectMode.newValue),void 0!==e.toggleKey&&(r.toggleKey=e.toggleKey.newValue),void 0!==e.autoHide&&(r.autoHide=e.autoHide.newValue),void 0!==e.showDuration&&(r.showDuration=e.showDuration.newValue),void 0!==e.showPosition&&(r.showPosition=e.showPosition.newValue)});var a=function(e){var t=window.getSelection&&window.getSelection();if(t&&t.rangeCount>0){var o=trim(t.toString()),a=t.getRangeAt(0).getBoundingClientRect();if(n(a,i)&&i.again)return void(i.again=0);if(""===o)return;for(var c=document.documentElement.querySelectorAll(".ChaZD-result-container"),d=0,s=c.length;d<s;d++)if(c[d].getAttribute("data-text").toLowerCase()===o.toLowerCase())return;for(var m in chrome.storage.sync.set({currentWord:o},function(){}),i)i[m]="again"==m?1:a[m];"side"===r.showPosition&&u(o,r.useHttps),"near"===r.showPosition&&l(o,r.useHttps,a,e)}},u=function(e,t){var n=d(e,t);n.classList.add("ChaZD-result-side"),document.documentElement.appendChild(n),r.autoHide&&(o=setTimeout(function(){document.querySelector(".ChaZD-result-container")&&document.documentElement.removeChild(n)},1e3*r.showDuration))},l=function(e,t,n,i){var a=d(e,t,function(){var e={};0===n.left&&0===n.top&&(n={left:i.clientX,top:i.clientY,height:15});var t=a.offsetWidth,l=n.right-n.left,c=n.left+window.pageXOffset,d=n.top+window.pageYOffset,s=l/2+c,m=c-(t-l)/2,h=s-12;m<window.pageXOffset?m=window.pageXOffset:m+t>window.pageXOffset+document.documentElement.clientWidth&&(m=window.pageXOffset+document.documentElement.clientWidth-t);var f=0;if(f=document.documentElement.clientHeight>document.body.clientHeight?document.body.clientHeight:document.documentElement.clientHeight,0===f&&(f=document.documentElement.clientHeight),n.top>=a.offsetHeight+12){var v=f-d+10,p=v+1;e={left:m,bottom:v,arrowLeft:h,arrowBottom:p}}else e={left:m,top:d+n.height+12,arrowLeft:h,arrowTop:d+n.height+1};a.style.left=e.left+"px",u.style.left=e.arrowLeft+"px";var g,w,y=document.querySelectorAll(".ChaZD-arrow-outer"),C=document.querySelectorAll(".ChaZD-arrow-inner");if(e.bottom)for(a.style.bottom=e.bottom+"px",u.style.bottom=e.arrowBottom+"px",g=0,w=y.length;g<w;g++)y[g].classList.add("ChaZD-arrow-outer-down"),C[g].classList.add("ChaZD-arrow-inner-down");if(e.top)for(a.style.top=e.top+"px",u.style.top=e.arrowTop+"px",g=0,w=y.length;g<w;g++)y[g].classList.add("ChaZD-arrow-outer-up"),C[g].classList.add("ChaZD-arrow-inner-up");r.autoHide&&(o=setTimeout(function(){document.querySelector(".ChaZD-result-container")&&document.querySelector(".ChaZD-arrow-main")&&(document.documentElement.removeChild(a),document.documentElement.removeChild(u))},1e3*r.showDuration))});document.documentElement.appendChild(a);var u=c();document.documentElement.appendChild(u)},c=function(){var e=document.createElement("div");e.classList.add("ChaZD-arrow-main");var t=document.createElement("div");t.setAttribute("class","ChaZD-arrow-outer");var n=document.createElement("div");return n.setAttribute("class","ChaZD-arrow-inner"),e.appendChild(t),e.appendChild(n),e},d=function(t,n,o){var i=document.createElement("div");i.classList.add("ChaZD-result-container"),i.setAttribute("data-text",t);var r=document.createElement("div");return r.setAttribute("id","ChaZD-searching"),r.innerHTML="ψ(._. )>划词君正在翻译。。。",i.appendChild(r),chrome.runtime.sendMessage({queryWord:t,source:"select",useHttps:n},function(t){var n=t;if(r.innerHTML="","query success"===n.validMessage){i.innerHTML=n.titleBlock;var a=i.querySelector(".voice-container");e(a);var u=document.createElement("div");n.basicBlock&&(u.innerHTML=n.basicBlock,i.appendChild(u)),n.haveTranslation&&(i.querySelector(".title-translation").style.display="block"),n.haveWebTranslation&&(u.innerHTML+=n.webBlock,i.appendChild(u),i.querySelector(".web-title").innerHTML="网络释义"),n.haveTranslation||n.haveWebTranslation||(i.innerHTML="╮(╯▽╰)╭划词君无能为力啊<br> 还是右键问问谷歌君吧=>")}else 20==n.errorCode?i.innerHTML="<p>这段文字太长，词典君无能为力了（┬_┬） <br><br>试试短一点的吧~</p>":40==n.errorCode?i.innerHTML="<p>对不起，这段文字太高深了，请饶过词典君吧（┬_┬）</p>":i.innerHTML="<p>词典君罢工啦（┬_┬）<br><br> 是不是网络不太好？<br><br> 稍后再试一次吧</p>";void 0!==o&&o()}),i},s=["ChaZD-result-container","title-container","title-word","title-translation","basic-container","phonetic-container","explains-container","explains-container","explains-list","property-container","explains-item","voice-container","us-phonetic-container","uk-phonetic-container","web-explains-container","web-explains-list","web-key","explains-item-value","web-value"];document.documentElement.addEventListener("mousedown",function(e){for(var t in s)if(e.target.classList.contains(s[t]))return;clearTimeout(o);var n,i,r=document.querySelectorAll(".ChaZD-result-container"),a=document.querySelectorAll(".ChaZD-arrow-main");if(r)for(n=0,i=r.length;n<i;n++)document.documentElement.removeChild(r[n]);if(a)for(n=0,i=a.length;n<i;n++)document.documentElement.removeChild(a[n]);chrome.storage.sync.set({currentWord:""})}),window.addEventListener("resize",function(e){var t=document.querySelector(".ChaZD-result-container"),n=document.querySelector(".ChaZD-arrow-main");t&&document.documentElement.removeChild(t),n&&document.documentElement.removeChild(n)});var m=function(e){if("noSelect"!==r.selectMode){if("useCtrl"===r.selectMode)if("ctrl"===r.toggleKey){if(!e.ctrlKey&&!e.metaKey)return void(i.again=0)}else if("alt"===r.toggleKey){if(!e.altKey)return void(i.again=0)}else if("shift"===r.toggleKey&&!e.shiftKey)return void(i.again=0);a(e)}},h=null,f=function(e){r.linkQuery&&(h=e.target,e.shiftKey&&p(e))},v=function(e){r.linkQuery&&(h&&h.classList.contains("ChaZD-link")&&g(e,!0),h=null)},p=function(e){h&&e.shiftKey&&(w(e),h.setAttribute("ChaZD-href",h.getAttribute("href")),h.removeAttribute("href"),h.classList.add("ChaZD-link"))},g=function(e,t){h&&(t||16==e.keyCode)&&(h.setAttribute("href",h.getAttribute("ChaZD-href")),h.removeAttribute("ChaZD-href"),h.classList.remove("ChaZD-link"))},w=function(e){r.linkQuery&&e.shiftKey&&window.getSelection().empty()};document.documentElement.addEventListener("mouseup",m),document.documentElement.addEventListener("mouseover",function(e){"A"!==e.target.nodeName&&"a"!==e.target.nodeName||f(e)}),document.documentElement.addEventListener("mouseout",function(e){"A"!==e.target.nodeName&&"a"!==e.target.nodeName||v(e)}),document.documentElement.addEventListener("keydown",p),document.documentElement.addEventListener("keyup",g),document.documentElement.addEventListener("selectstart",m)})();